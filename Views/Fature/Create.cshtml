@model PROJEKTDB.Models.FatureCreateVM
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Linq

<h1>Shto Fature</h1>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

   

    <div class="mb-3">
        <label class="form-label">Person</label>
        <select class="form-select"
                asp-for="PerId"
                asp-items="(IEnumerable<SelectListItem>)ViewBag.Persons ?? Enumerable.Empty<SelectListItem>()">
            <option value="">-- Zgjidh person --</option>
        </select>
        <span asp-validation-for="PerId" class="text-danger"></span>
    </div>

    

    <hr />

    <div class="mb-3">
        <label class="form-label">Piktura</label>
        <select class="form-select"
                asp-for="PikId"
                asp-items="(IEnumerable<SelectListItem>)ViewBag.Piktures ?? Enumerable.Empty<SelectListItem>()"
                id="pikSelect">
            <option value="">-- Zgjidh pikture --</option>
        </select>
        <span asp-validation-for="PikId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Sasia</label>
        <input class="form-control" asp-for="RreSasi" />
        <span asp-validation-for="RreSasi" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Vlera (cmimi)</label>
        <input class="form-control" asp-for="PikCmim" id="pikCmim" readonly />
    </div>

    <div class="mb-3">
        <label class="form-label">Artisti</label>
        <input class="form-control" asp-for="ArtistEmri" id="artistEmri" readonly />
    </div>

    <button class="btn btn-primary" type="submit">Save</button>
    <a class="btn btn-secondary" asp-action="Index">Back</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sel = document.getElementById('pikSelect');
            const cmim = document.getElementById('pikCmim');
            const artist = document.getElementById('artistEmri');

            if (!sel) return;

            async function loadInfo() {
                const id = sel.value;

                if (!id) {
                    if (cmim) cmim.value = '';
                    if (artist) artist.value = '';
                    return;
                }

                const url = '@Url.Action("GetPiktureInfo", "Fature")' + '?id=' + encodeURIComponent(id);
                const res = await fetch(url);

                if (!res.ok) {
                    if (cmim) cmim.value = '';
                    if (artist) artist.value = '';
                    return;
                }

                const data = await res.json();
                const price = data.cmim ?? 0;
                if (cmim) cmim.value = Number(price).toFixed(2);
                if (artist) artist.value = data.artist ?? '';
            }

            sel.addEventListener('change', loadInfo);
            loadInfo();
        });
    </script>
}
